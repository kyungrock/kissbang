<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>회원가입 - 마사지가가</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .signup-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 100%;
        padding: 50px 40px;
        animation: fadeInUp 0.6s ease;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .signup-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .logo-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        overflow: hidden;
      }

      .logo-icon i {
        font-size: 40px;
        color: white;
      }

      .logo-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .signup-title {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin-bottom: 10px;
      }

      .signup-subtitle {
        color: #666;
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }

      .form-label .required {
        color: #dc3545;
      }

      .input-wrapper {
        position: relative;
      }

      .input-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        font-size: 16px;
      }

      .form-input {
        width: 100%;
        padding: 14px 14px 14px 45px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.3s;
        box-sizing: border-box;
        color: #333;
      }

      .form-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      }

      .form-input::placeholder {
        color: #adb5bd;
      }

      .form-input.is-valid {
        border-color: #28a745;
      }

      .form-input.is-invalid {
        border-color: #dc3545;
      }

      .password-toggle {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #999;
        font-size: 16px;
        transition: color 0.3s;
      }

      .password-toggle:hover {
        color: #667eea;
      }

      .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .error-text {
        font-size: 12px;
        color: #dc3545;
        margin-top: 5px;
        display: none;
      }

      .error-text.show {
        display: block;
      }

      .image-preview {
        margin-top: 10px;
        display: none;
      }

      .image-preview.show {
        display: block;
      }

      .preview-img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #667eea;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .password-strength {
        margin-top: 10px;
      }

      .strength-bar {
        height: 4px;
        background: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 5px;
      }

      .strength-bar-fill {
        height: 100%;
        width: 0;
        transition: all 0.3s;
      }

      .strength-bar-fill.weak {
        width: 33%;
        background: #dc3545;
      }

      .strength-bar-fill.medium {
        width: 66%;
        background: #ffc107;
      }

      .strength-bar-fill.strong {
        width: 100%;
        background: #28a745;
      }

      .strength-text {
        font-size: 12px;
        color: #666;
      }

      .terms-group {
        margin: 25px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .term-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }

      .term-item:last-child {
        margin-bottom: 0;
      }

      .term-item input[type='checkbox'] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .term-item label {
        flex: 1;
        cursor: pointer;
        font-size: 14px;
        color: #333;
      }

      .term-link {
        color: #667eea;
        text-decoration: none;
        font-size: 12px;
      }

      .term-link:hover {
        text-decoration: underline;
      }

      .signup-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .signup-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
      }

      .signup-btn:active {
        transform: translateY(0);
      }

      .signup-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .login-link {
        text-align: center;
        margin-top: 25px;
        font-size: 14px;
        color: #666;
      }

      .login-link a {
        color: #667eea;
        font-weight: 600;
        text-decoration: none;
        transition: color 0.3s;
      }

      .login-link a:hover {
        color: #764ba2;
      }

      .back-home {
        text-align: center;
        margin-top: 20px;
      }

      .back-home a {
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: color 0.3s;
      }

      .back-home a:hover {
        color: #764ba2;
      }

      .error-message {
        background: #fee;
        color: #c33;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
        animation: shake 0.5s;
      }

      .error-message.show {
        display: block;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }

      .success-message.show {
        display: block;
      }

      .mongo-status {
        display: none;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 14px;
        text-align: center;
        font-weight: 600;
      }

      .mongo-status.show {
        display: block;
        animation: slideDown 0.3s ease;
      }

      .mongo-status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .mongo-status.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .mongo-status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @media (max-width: 480px) {
        .signup-container {
          padding: 40px 30px;
        }

        .signup-title {
          font-size: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="signup-container">
      <div class="signup-header">
        <div class="logo-icon" id="logoIcon">
          <!-- 로고 이미지 URL을 여기에 삽입하세요 -->
          <!-- <img src="https://your-logo-url.com/logo.png" alt="마사지가가 로고"> -->
          <i class="fas fa-user-plus"></i>
        </div>
        <h1 class="signup-title">회원가입</h1>
        <p class="signup-subtitle">마사지가가의 새로운 회원이 되어보세요</p>
      </div>

      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>
      <div id="mongoStatus" class="mongo-status"></div>

      <form id="signupForm">
        <div class="form-group">
          <label for="username" class="form-label">
            아이디 <span class="required">*</span>
          </label>
          <div class="input-wrapper">
            <i class="fas fa-user input-icon"></i>
            <input
              type="text"
              id="username"
              name="username"
              class="form-input"
              placeholder="아이디 (4자 이상)"
              required
            />
          </div>
          <div class="help-text">4-20자의 영문, 숫자를 사용하세요</div>
          <div id="usernameError" class="error-text"></div>
        </div>

        <div class="form-group">
          <label for="email" class="form-label">
            이메일 <span class="required">*</span>
          </label>
          <div class="input-wrapper">
            <i class="fas fa-envelope input-icon"></i>
            <input
              type="email"
              id="email"
              name="email"
              class="form-input"
              placeholder="example@email.com"
              required
            />
          </div>
          <div id="emailError" class="error-text"></div>
        </div>

        <div class="form-group">
          <label for="password" class="form-label">
            비밀번호 <span class="required">*</span>
          </label>
          <div class="input-wrapper">
            <i class="fas fa-lock input-icon"></i>
            <input
              type="password"
              id="password"
              name="password"
              class="form-input"
              placeholder="비밀번호 (6자 이상)"
              required
            />
            <i class="fas fa-eye password-toggle" id="passwordToggle"></i>
          </div>
          <div class="password-strength">
            <div class="strength-bar">
              <div class="strength-bar-fill" id="strengthBar"></div>
            </div>
            <div class="strength-text" id="strengthText"></div>
          </div>
          <div id="passwordError" class="error-text"></div>
        </div>

        <div class="form-group">
          <label for="passwordConfirm" class="form-label">
            비밀번호 확인 <span class="required">*</span>
          </label>
          <div class="input-wrapper">
            <i class="fas fa-lock input-icon"></i>
            <input
              type="password"
              id="passwordConfirm"
              name="passwordConfirm"
              class="form-input"
              placeholder="비밀번호를 다시 입력하세요"
              required
            />
            <i
              class="fas fa-eye password-toggle"
              id="passwordConfirmToggle"
            ></i>
          </div>
          <div id="passwordConfirmError" class="error-text"></div>
        </div>

        <div class="form-group">
          <label for="name" class="form-label">
            이름 <span class="required">*</span>
          </label>
          <div class="input-wrapper">
            <i class="fas fa-id-card input-icon"></i>
            <input
              type="text"
              id="name"
              name="name"
              class="form-input"
              placeholder="이름"
              required
            />
          </div>
          <div id="nameError" class="error-text"></div>
        </div>

        <div class="form-group">
          <label for="phone" class="form-label">
            연락처 <span class="required">*</span>
          </label>
          <div class="input-wrapper">
            <i class="fas fa-phone input-icon"></i>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="form-input"
              placeholder="010-0000-0000"
              required
            />
          </div>
          <div id="phoneError" class="error-text"></div>
        </div>

        <div class="form-group">
          <label for="profileImage" class="form-label">
            프로필 이미지 URL (선택)
          </label>
          <div class="input-wrapper">
            <i class="fas fa-image input-icon"></i>
            <input
              type="url"
              id="profileImage"
              name="profileImage"
              class="form-input"
              placeholder="https://i.imgur.com/yourimage.jpg"
            />
          </div>
          <div class="help-text">프로필 사진 URL을 입력하세요 (선택사항)</div>
          <div id="imagePreview" class="image-preview">
            <img id="previewImg" class="preview-img" alt="미리보기" />
          </div>
        </div>

        <div class="terms-group">
          <div class="term-item">
            <input type="checkbox" id="agreeAll" />
            <label for="agreeAll"><strong>전체 동의</strong></label>
          </div>
          <div class="term-item">
            <input
              type="checkbox"
              id="agreeTerms"
              class="term-checkbox"
              required
            />
            <label for="agreeTerms">
              [필수] 이용약관 동의
              <a href="#" class="term-link">(보기)</a>
            </label>
          </div>
          <div class="term-item">
            <input
              type="checkbox"
              id="agreePrivacy"
              class="term-checkbox"
              required
            />
            <label for="agreePrivacy">
              [필수] 개인정보 처리방침 동의
              <a href="#" class="term-link">(보기)</a>
            </label>
          </div>
          <div class="term-item">
            <input type="checkbox" id="agreeMarketing" class="term-checkbox" />
            <label for="agreeMarketing">
              [선택] 마케팅 정보 수신 동의
              <a href="#" class="term-link">(보기)</a>
            </label>
          </div>
        </div>

        <button type="submit" class="signup-btn" id="signupBtn">
          <i class="fas fa-user-plus"></i> 회원가입
        </button>
      </form>

      <div class="login-link">
        이미 계정이 있으신가요? <a href="login.html">로그인</a>
      </div>

      <div class="back-home">
        <a href="index.html"> <i class="fas fa-home"></i> 홈으로 돌아가기 </a>
      </div>
    </div>

    <script src="api-auth.js"></script>
    <script>
      // 비밀번호 표시/숨김 토글
      const passwordToggle = document.getElementById('passwordToggle');
      const passwordInput = document.getElementById('password');
      const passwordConfirmToggle = document.getElementById(
        'passwordConfirmToggle'
      );
      const passwordConfirmInput = document.getElementById('passwordConfirm');

      passwordToggle.addEventListener('click', function () {
        const type = passwordInput.type === 'password' ? 'text' : 'password';
        passwordInput.type = type;
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
      });

      passwordConfirmToggle.addEventListener('click', function () {
        const type =
          passwordConfirmInput.type === 'password' ? 'text' : 'password';
        passwordConfirmInput.type = type;
        this.classList.toggle('fa-eye');
        this.classList.toggle('fa-eye-slash');
      });

      // 비밀번호 강도 체크
      const strengthBar = document.getElementById('strengthBar');
      const strengthText = document.getElementById('strengthText');

      passwordInput.addEventListener('input', function () {
        const password = this.value;
        let strength = 0;

        if (password.length >= 6) strength++;
        if (password.length >= 10) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;

        strengthBar.className = 'strength-bar-fill';

        if (strength <= 2) {
          strengthBar.classList.add('weak');
          strengthText.textContent = '약함';
          strengthText.style.color = '#dc3545';
        } else if (strength <= 3) {
          strengthBar.classList.add('medium');
          strengthText.textContent = '보통';
          strengthText.style.color = '#ffc107';
        } else {
          strengthBar.classList.add('strong');
          strengthText.textContent = '강함';
          strengthText.style.color = '#28a745';
        }
      });

      // 전체 동의 체크박스
      const agreeAll = document.getElementById('agreeAll');
      const termCheckboxes = document.querySelectorAll('.term-checkbox');

      agreeAll.addEventListener('change', function () {
        termCheckboxes.forEach((checkbox) => {
          checkbox.checked = this.checked;
        });
      });

      termCheckboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', function () {
          const allChecked = Array.from(termCheckboxes).every(
            (cb) => cb.checked
          );
          agreeAll.checked = allChecked;
        });
      });

      // 전화번호 포맷팅
      const phoneInput = document.getElementById('phone');
      phoneInput.addEventListener('input', function () {
        let value = this.value.replace(/[^0-9]/g, '');

        if (value.length <= 3) {
          this.value = value;
        } else if (value.length <= 7) {
          this.value = value.slice(0, 3) + '-' + value.slice(3);
        } else {
          this.value =
            value.slice(0, 3) +
            '-' +
            value.slice(3, 7) +
            '-' +
            value.slice(7, 11);
        }
      });

      // 프로필 이미지 미리보기
      const profileImageInput = document.getElementById('profileImage');
      const imagePreview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');

      profileImageInput.addEventListener('input', function () {
        const url = this.value.trim();

        if (url) {
          previewImg.src = url;
          imagePreview.classList.add('show');

          // 이미지 로드 에러 처리
          previewImg.onerror = function () {
            imagePreview.classList.remove('show');
          };
        } else {
          imagePreview.classList.remove('show');
        }
      });

      // MongoDB 상태 확인
      async function checkMongoDBStatus() {
        const mongoStatus = document.getElementById('mongoStatus');

        try {
          const response = await fetch('/api/auth/me', {
            method: 'GET',
            credentials: 'include',
          });

          if (response.status === 401) {
            // 401은 정상 (로그인 안 한 상태)
            mongoStatus.textContent =
              '✅ MongoDB 백엔드 연결됨 - 계정이 모든 기기에서 동기화됩니다';
            mongoStatus.className = 'mongo-status success show';
            return true;
          } else if (response.ok || response.status < 500) {
            mongoStatus.textContent =
              '✅ MongoDB 백엔드 연결됨 - 계정이 모든 기기에서 동기화됩니다';
            mongoStatus.className = 'mongo-status success show';
            return true;
          } else {
            mongoStatus.textContent =
              '⚠️ MongoDB 서버 오류 - localStorage로 저장됩니다 (기기별 분리)';
            mongoStatus.className = 'mongo-status warning show';
            return false;
          }
        } catch (error) {
          mongoStatus.textContent =
            '⚠️ MongoDB 연결 실패 - localStorage로 저장됩니다 (기기별 분리)';
          mongoStatus.className = 'mongo-status warning show';
          return false;
        }
      }

      // 페이지 로드 시 MongoDB 상태 확인
      checkMongoDBStatus();

      // 회원가입 폼 제출
      const signupForm = document.getElementById('signupForm');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');

      signupForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        // 에러 메시지 초기화
        errorMessage.classList.remove('show');
        successMessage.classList.remove('show');
        document
          .querySelectorAll('.error-text')
          .forEach((el) => el.classList.remove('show'));

        // 폼 데이터 수집
        const formData = {
          username: document.getElementById('username').value,
          email: document.getElementById('email').value,
          password: document.getElementById('password').value,
          passwordConfirm: document.getElementById('passwordConfirm').value,
          name: document.getElementById('name').value,
          phone: document.getElementById('phone').value,
          profileImage: document.getElementById('profileImage').value,
        };

        // 유효성 검사
        let hasError = false;

        // 비밀번호 확인
        if (formData.password !== formData.passwordConfirm) {
          document.getElementById('passwordConfirmError').textContent =
            '비밀번호가 일치하지 않습니다.';
          document.getElementById('passwordConfirmError').classList.add('show');
          hasError = true;
        }

        // 필수 약관 동의 확인
        const agreeTerms = document.getElementById('agreeTerms').checked;
        const agreePrivacy = document.getElementById('agreePrivacy').checked;

        if (!agreeTerms || !agreePrivacy) {
          errorMessage.textContent = '필수 약관에 동의해주세요.';
          errorMessage.classList.add('show');
          hasError = true;
        }

        if (hasError) return;

        console.log('📋 회원가입 폼 데이터:', formData);

        // 회원가입 시도 (await 추가)
        const result = await authManager.register(formData);

        console.log('📊 회원가입 결과:', result);

        if (result.success) {
          console.log('✅ 회원가입 성공! 사용자:', result.user);

          // localStorage 확인 (디버깅용)
          const savedUsers = JSON.parse(
            localStorage.getItem('kissbang_global_users') || '[]'
          );
          console.log(
            '💾 저장된 전체 사용자:',
            savedUsers.map((u) => u.username)
          );

          successMessage.textContent =
            '회원가입이 완료되었습니다! 디버그 페이지로 이동합니다...';
          successMessage.classList.add('show');

          setTimeout(() => {
            // 디버그 페이지로 이동하여 확인
            window.location.href = 'debug-storage.html';
          }, 2000);
        } else {
          console.error('❌ 회원가입 실패:', result.error);
          errorMessage.textContent = '회원가입 실패: ' + result.error;
          errorMessage.classList.add('show');
        }
      });

      // 이미 로그인된 경우 리다이렉트
      if (authManager.isLoggedIn()) {
        window.location.href = 'index.html';
      }
    </script>
  </body>
</html>
