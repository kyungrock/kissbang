<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>스토리지 디버그</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        padding: 20px;
        background: #1e1e1e;
        color: #d4d4d4;
      }
      .section {
        background: #252526;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        border: 1px solid #3e3e42;
      }
      h2 {
        color: #4ec9b0;
        margin-top: 0;
      }
      pre {
        background: #1e1e1e;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        border: 1px solid #3e3e42;
      }
      .user-card {
        background: #2d2d30;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 3px solid #4ec9b0;
      }
      .btn {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
      }
      .btn-primary {
        background: #0e639c;
        color: white;
      }
      .btn-danger {
        background: #f48771;
        color: white;
      }
      .btn-success {
        background: #89d185;
        color: #1e1e1e;
      }
      .info {
        color: #ce9178;
      }
      .success {
        color: #89d185;
      }
      .error {
        color: #f48771;
      }
    </style>
  </head>
  <body>
    <h1>🔍 스토리지 디버그 도구</h1>

    <div class="section">
      <h2>🌐 MongoDB 사용자 (실제 DB)</h2>
      <button class="btn btn-primary" onclick="loadMongoUsers()">
        🔄 MongoDB 확인
      </button>
      <div id="mongoUsers"></div>
    </div>

    <div class="section">
      <h2>💾 localStorage 사용자 (로컬 캐시)</h2>
      <button class="btn btn-primary" onclick="refreshData()">
        🔄 새로고침
      </button>
      <button class="btn btn-danger" onclick="clearAll()">🗑️ 모두 삭제</button>
      <button class="btn btn-success" onclick="createTestUser()">
        ➕ 테스트 계정 생성
      </button>
      <div id="userData"></div>
    </div>

    <div class="section">
      <h2>🔐 로그인 테스트</h2>
      <input
        type="text"
        id="testUsername"
        placeholder="아이디"
        style="padding: 8px; margin: 5px; width: 200px"
      />
      <input
        type="password"
        id="testPassword"
        placeholder="비밀번호"
        style="padding: 8px; margin: 5px; width: 200px"
      />
      <button class="btn btn-primary" onclick="testLogin()">
        로그인 테스트
      </button>
      <div id="loginResult" style="margin-top: 10px"></div>
    </div>

    <div class="section">
      <h2>💾 Raw 데이터</h2>
      <div id="rawData"></div>
    </div>

    <script src="api-auth.js"></script>
    <script>
      // MongoDB 사용자 목록 로드
      async function loadMongoUsers() {
        const resultDiv = document.getElementById('mongoUsers');
        resultDiv.innerHTML = '<p class="info">MongoDB에서 사용자 목록을 가져오는 중...</p>';

        try {
          // API 엔드포인트로 모든 사용자 가져오기 (관리자 기능)
          const response = await fetch('/api/users/all', {
            method: 'GET',
            credentials: 'include',
          });

          if (response.ok) {
            const data = await response.json();
            const users = data.users || [];

            if (users.length === 0) {
              resultDiv.innerHTML = '<p class="error">MongoDB에 사용자가 없습니다.</p>';
              return;
            }

            const userHtml = users
              .map(
                (u) => `
              <div class="user-card">
                <div><strong class="success">아이디:</strong> ${u.username || 'N/A'}</div>
                <div><strong class="success">이메일:</strong> ${u.email}</div>
                <div><strong class="success">이름:</strong> ${u.name || 'N/A'}</div>
                <div><strong class="success">권한:</strong> ${u.role}</div>
                <div><strong class="success">활성:</strong> ${u.isActive !== false ? 'Yes' : 'No'}</div>
                <div><strong class="info">생성일:</strong> ${new Date(u.createdAt).toLocaleString('ko-KR')}</div>
              </div>
            `
              )
              .join('');

            resultDiv.innerHTML = `
              <p class="success">✅ MongoDB 사용자 수: ${users.length}</p>
              ${userHtml}
            `;
          } else {
            // API 엔드포인트가 없거나 권한 없음 - 세션 정보로 대체
            const sessionResponse = await fetch('/api/auth/me', {
              method: 'GET',
              credentials: 'include',
            });

            if (sessionResponse.ok) {
              const data = await sessionResponse.json();
              const user = data.user;

              resultDiv.innerHTML = `
                <p class="info">⚠️ 전체 목록 조회 권한 없음. 현재 로그인된 사용자만 표시:</p>
                <div class="user-card">
                  <div><strong class="success">아이디:</strong> ${user.username || 'N/A'}</div>
                  <div><strong class="success">이메일:</strong> ${user.email}</div>
                  <div><strong class="success">이름:</strong> ${user.name || 'N/A'}</div>
                  <div><strong class="success">권한:</strong> ${user.role}</div>
                </div>
              `;
            } else {
              resultDiv.innerHTML = `
                <p class="error">❌ MongoDB API 연결 실패</p>
                <p class="info">Status: ${response.status}</p>
                <p class="info">MongoDB 백엔드가 작동하지 않거나 로그인이 필요합니다.</p>
              `;
            }
          }
        } catch (error) {
          resultDiv.innerHTML = `
            <p class="error">❌ MongoDB 연결 실패</p>
            <p class="error">Error: ${error.message}</p>
            <p class="info">MongoDB 백엔드가 작동하지 않습니다.</p>
          `;
        }
      }

      function refreshData() {
        // 전역 사용자
        const globalUsers = JSON.parse(
          localStorage.getItem('kissbang_global_users') || '[]'
        );

        // 로컬 사용자
        const localUsers = JSON.parse(
          localStorage.getItem('kissbang_users') || '[]'
        );

        // 병합
        const allUsers = [...globalUsers, ...localUsers];
        const uniqueUsers = Array.from(
          new Map(allUsers.map((u) => [u.username, u])).values()
        );

        // 사용자 카드 표시
        const userHtml =
          uniqueUsers.length === 0
            ? '<p class="error">저장된 사용자가 없습니다.</p>'
            : uniqueUsers
                .map(
                  (u) => `
          <div class="user-card">
            <div><strong class="success">아이디:</strong> ${u.username}</div>
            <div><strong class="success">이메일:</strong> ${u.email}</div>
            <div><strong class="success">이름:</strong> ${u.name}</div>
            <div><strong class="success">비밀번호:</strong> ${u.password}</div>
            <div><strong class="success">권한:</strong> ${u.role}</div>
            <div><strong class="success">활성:</strong> ${
              u.isActive ? 'Yes' : 'No'
            }</div>
            <div><strong class="info">생성일:</strong> ${new Date(
              u.createdAt
            ).toLocaleString('ko-KR')}</div>
          </div>
        `
                )
                .join('');

        document.getElementById('userData').innerHTML = `
        <p class="info">전역 사용자 수: ${globalUsers.length}</p>
        <p class="info">로컬 사용자 수: ${localUsers.length}</p>
        <p class="success">총 고유 사용자 수: ${uniqueUsers.length}</p>
        ${userHtml}
      `;

        // Raw 데이터
        document.getElementById('rawData').innerHTML = `
        <p><strong>kissbang_global_users:</strong></p>
        <pre>${JSON.stringify(globalUsers, null, 2)}</pre>
        <p><strong>kissbang_users:</strong></p>
        <pre>${JSON.stringify(localUsers, null, 2)}</pre>
        <p><strong>currentUser:</strong></p>
        <pre>${localStorage.getItem('currentUser') || 'null'}</pre>
      `;
      }

      function clearAll() {
        if (confirm('정말로 모든 데이터를 삭제하시겠습니까?')) {
          localStorage.clear();
          sessionStorage.clear();
          alert('모든 데이터가 삭제되었습니다!');
          refreshData();
        }
      }

      function createTestUser() {
        const users = JSON.parse(
          localStorage.getItem('kissbang_global_users') || '[]'
        );

        const testUser = {
          id: 'test-' + Date.now(),
          username: 'testuser',
          email: 'test@test.com',
          password: 'test1234',
          name: '테스트유저',
          phone: '010-1234-5678',
          profileImage: '',
          role: 'user',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          isActive: true,
          lastLogin: null,
        };

        users.push(testUser);
        localStorage.setItem('kissbang_global_users', JSON.stringify(users));
        localStorage.setItem('kissbang_users', JSON.stringify(users));

        alert('테스트 계정 생성 완료!\n\n아이디: testuser\n비밀번호: test1234');
        refreshData();
      }

      async function testLogin() {
        const username = document.getElementById('testUsername').value;
        const password = document.getElementById('testPassword').value;

        if (!username || !password) {
          alert('아이디와 비밀번호를 입력하세요!');
          return;
        }

        const result = await authManager.login(username, password);

        const resultDiv = document.getElementById('loginResult');
        if (result.success) {
          resultDiv.innerHTML = `<p class="success">✅ 로그인 성공!</p><pre>${JSON.stringify(
            result.user,
            null,
            2
          )}</pre>`;
        } else {
          resultDiv.innerHTML = `<p class="error">❌ 로그인 실패: ${result.error}</p>`;
        }
      }

      // 초기 로드
      refreshData();
      loadMongoUsers();

      // 5초마다 자동 새로고침
      setInterval(refreshData, 5000);
      setInterval(loadMongoUsers, 5000);
    </script>
  </body>
</html>
