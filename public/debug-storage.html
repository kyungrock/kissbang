<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìŠ¤í† ë¦¬ì§€ ë””ë²„ê·¸</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        padding: 20px;
        background: #1e1e1e;
        color: #d4d4d4;
      }
      .section {
        background: #252526;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        border: 1px solid #3e3e42;
      }
      h2 {
        color: #4ec9b0;
        margin-top: 0;
      }
      pre {
        background: #1e1e1e;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        border: 1px solid #3e3e42;
      }
      .user-card {
        background: #2d2d30;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 3px solid #4ec9b0;
      }
      .btn {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
      }
      .btn-primary {
        background: #0e639c;
        color: white;
      }
      .btn-danger {
        background: #f48771;
        color: white;
      }
      .btn-success {
        background: #89d185;
        color: #1e1e1e;
      }
      .info {
        color: #ce9178;
      }
      .success {
        color: #89d185;
      }
      .error {
        color: #f48771;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” ìŠ¤í† ë¦¬ì§€ ë””ë²„ê·¸ ë„êµ¬</h1>

    <div class="section">
      <h2>ğŸŒ MongoDB ì‚¬ìš©ì (ì‹¤ì œ DB)</h2>
      <button class="btn btn-primary" onclick="loadMongoUsers()">
        ğŸ”„ MongoDB í™•ì¸
      </button>
      <div id="mongoUsers"></div>
    </div>

    <div class="section">
      <h2>ğŸ’¾ localStorage ì‚¬ìš©ì (ë¡œì»¬ ìºì‹œ)</h2>
      <button class="btn btn-primary" onclick="refreshData()">
        ğŸ”„ ìƒˆë¡œê³ ì¹¨
      </button>
      <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ ëª¨ë‘ ì‚­ì œ</button>
      <button class="btn btn-success" onclick="createTestUser()">
        â• í…ŒìŠ¤íŠ¸ ê³„ì • ìƒì„±
      </button>
      <div id="userData"></div>
    </div>

    <div class="section">
      <h2>ğŸ” ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h2>
      <input
        type="text"
        id="testUsername"
        placeholder="ì•„ì´ë””"
        style="padding: 8px; margin: 5px; width: 200px"
      />
      <input
        type="password"
        id="testPassword"
        placeholder="ë¹„ë°€ë²ˆí˜¸"
        style="padding: 8px; margin: 5px; width: 200px"
      />
      <button class="btn btn-primary" onclick="testLogin()">
        ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
      </button>
      <div id="loginResult" style="margin-top: 10px"></div>
    </div>

    <div class="section">
      <h2>ğŸ’¾ Raw ë°ì´í„°</h2>
      <div id="rawData"></div>
    </div>

    <script src="api-auth.js"></script>
    <script>
      // MongoDB ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
      async function loadMongoUsers() {
        const resultDiv = document.getElementById('mongoUsers');
        resultDiv.innerHTML = '<p class="info">MongoDBì—ì„œ ì‚¬ìš©ì ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>';

        try {
          // API ì—”ë“œí¬ì¸íŠ¸ë¡œ ëª¨ë“  ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸° (ê´€ë¦¬ì ê¸°ëŠ¥)
          const response = await fetch('/api/users/all', {
            method: 'GET',
            credentials: 'include',
          });

          if (response.ok) {
            const data = await response.json();
            const users = data.users || [];

            if (users.length === 0) {
              resultDiv.innerHTML = '<p class="error">MongoDBì— ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
              return;
            }

            const userHtml = users
              .map(
                (u) => `
              <div class="user-card">
                <div><strong class="success">ì•„ì´ë””:</strong> ${u.username || 'N/A'}</div>
                <div><strong class="success">ì´ë©”ì¼:</strong> ${u.email}</div>
                <div><strong class="success">ì´ë¦„:</strong> ${u.name || 'N/A'}</div>
                <div><strong class="success">ê¶Œí•œ:</strong> ${u.role}</div>
                <div><strong class="success">í™œì„±:</strong> ${u.isActive !== false ? 'Yes' : 'No'}</div>
                <div><strong class="info">ìƒì„±ì¼:</strong> ${new Date(u.createdAt).toLocaleString('ko-KR')}</div>
              </div>
            `
              )
              .join('');

            resultDiv.innerHTML = `
              <p class="success">âœ… MongoDB ì‚¬ìš©ì ìˆ˜: ${users.length}</p>
              ${userHtml}
            `;
          } else {
            // API ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ê±°ë‚˜ ê¶Œí•œ ì—†ìŒ - ì„¸ì…˜ ì •ë³´ë¡œ ëŒ€ì²´
            const sessionResponse = await fetch('/api/auth/me', {
              method: 'GET',
              credentials: 'include',
            });

            if (sessionResponse.ok) {
              const data = await sessionResponse.json();
              const user = data.user;

              resultDiv.innerHTML = `
                <p class="info">âš ï¸ ì „ì²´ ëª©ë¡ ì¡°íšŒ ê¶Œí•œ ì—†ìŒ. í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë§Œ í‘œì‹œ:</p>
                <div class="user-card">
                  <div><strong class="success">ì•„ì´ë””:</strong> ${user.username || 'N/A'}</div>
                  <div><strong class="success">ì´ë©”ì¼:</strong> ${user.email}</div>
                  <div><strong class="success">ì´ë¦„:</strong> ${user.name || 'N/A'}</div>
                  <div><strong class="success">ê¶Œí•œ:</strong> ${user.role}</div>
                </div>
              `;
            } else {
              resultDiv.innerHTML = `
                <p class="error">âŒ MongoDB API ì—°ê²° ì‹¤íŒ¨</p>
                <p class="info">Status: ${response.status}</p>
                <p class="info">MongoDB ë°±ì—”ë“œê°€ ì‘ë™í•˜ì§€ ì•Šê±°ë‚˜ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
              `;
            }
          }
        } catch (error) {
          resultDiv.innerHTML = `
            <p class="error">âŒ MongoDB ì—°ê²° ì‹¤íŒ¨</p>
            <p class="error">Error: ${error.message}</p>
            <p class="info">MongoDB ë°±ì—”ë“œê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
          `;
        }
      }

      function refreshData() {
        // ì „ì—­ ì‚¬ìš©ì
        const globalUsers = JSON.parse(
          localStorage.getItem('kissbang_global_users') || '[]'
        );

        // ë¡œì»¬ ì‚¬ìš©ì
        const localUsers = JSON.parse(
          localStorage.getItem('kissbang_users') || '[]'
        );

        // ë³‘í•©
        const allUsers = [...globalUsers, ...localUsers];
        const uniqueUsers = Array.from(
          new Map(allUsers.map((u) => [u.username, u])).values()
        );

        // ì‚¬ìš©ì ì¹´ë“œ í‘œì‹œ
        const userHtml =
          uniqueUsers.length === 0
            ? '<p class="error">ì €ì¥ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
            : uniqueUsers
                .map(
                  (u) => `
          <div class="user-card">
            <div><strong class="success">ì•„ì´ë””:</strong> ${u.username}</div>
            <div><strong class="success">ì´ë©”ì¼:</strong> ${u.email}</div>
            <div><strong class="success">ì´ë¦„:</strong> ${u.name}</div>
            <div><strong class="success">ë¹„ë°€ë²ˆí˜¸:</strong> ${u.password}</div>
            <div><strong class="success">ê¶Œí•œ:</strong> ${u.role}</div>
            <div><strong class="success">í™œì„±:</strong> ${
              u.isActive ? 'Yes' : 'No'
            }</div>
            <div><strong class="info">ìƒì„±ì¼:</strong> ${new Date(
              u.createdAt
            ).toLocaleString('ko-KR')}</div>
          </div>
        `
                )
                .join('');

        document.getElementById('userData').innerHTML = `
        <p class="info">ì „ì—­ ì‚¬ìš©ì ìˆ˜: ${globalUsers.length}</p>
        <p class="info">ë¡œì»¬ ì‚¬ìš©ì ìˆ˜: ${localUsers.length}</p>
        <p class="success">ì´ ê³ ìœ  ì‚¬ìš©ì ìˆ˜: ${uniqueUsers.length}</p>
        ${userHtml}
      `;

        // Raw ë°ì´í„°
        document.getElementById('rawData').innerHTML = `
        <p><strong>kissbang_global_users:</strong></p>
        <pre>${JSON.stringify(globalUsers, null, 2)}</pre>
        <p><strong>kissbang_users:</strong></p>
        <pre>${JSON.stringify(localUsers, null, 2)}</pre>
        <p><strong>currentUser:</strong></p>
        <pre>${localStorage.getItem('currentUser') || 'null'}</pre>
      `;
      }

      function clearAll() {
        if (confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          localStorage.clear();
          sessionStorage.clear();
          alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
          refreshData();
        }
      }

      function createTestUser() {
        const users = JSON.parse(
          localStorage.getItem('kissbang_global_users') || '[]'
        );

        const testUser = {
          id: 'test-' + Date.now(),
          username: 'testuser',
          email: 'test@test.com',
          password: 'test1234',
          name: 'í…ŒìŠ¤íŠ¸ìœ ì €',
          phone: '010-1234-5678',
          profileImage: '',
          role: 'user',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          isActive: true,
          lastLogin: null,
        };

        users.push(testUser);
        localStorage.setItem('kissbang_global_users', JSON.stringify(users));
        localStorage.setItem('kissbang_users', JSON.stringify(users));

        alert('í…ŒìŠ¤íŠ¸ ê³„ì • ìƒì„± ì™„ë£Œ!\n\nì•„ì´ë””: testuser\në¹„ë°€ë²ˆí˜¸: test1234');
        refreshData();
      }

      async function testLogin() {
        const username = document.getElementById('testUsername').value;
        const password = document.getElementById('testPassword').value;

        if (!username || !password) {
          alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
          return;
        }

        const result = await authManager.login(username, password);

        const resultDiv = document.getElementById('loginResult');
        if (result.success) {
          resultDiv.innerHTML = `<p class="success">âœ… ë¡œê·¸ì¸ ì„±ê³µ!</p><pre>${JSON.stringify(
            result.user,
            null,
            2
          )}</pre>`;
        } else {
          resultDiv.innerHTML = `<p class="error">âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${result.error}</p>`;
        }
      }

      // ì´ˆê¸° ë¡œë“œ
      refreshData();
      loadMongoUsers();

      // 5ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
      setInterval(refreshData, 5000);
      setInterval(loadMongoUsers, 5000);
    </script>
  </body>
</html>
